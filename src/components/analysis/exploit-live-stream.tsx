"use client";

import { useEffect, useRef, useState } from "react";

interface SSEEvent {
  type: "thought" | "command" | "output" | "result" | "done";
  data: Record<string, unknown>;
  timestamp: string;
}

interface ExploitLiveStreamProps {
  exploitSessionId: string;
}

function formatTime(timestamp: string): string {
  try {
    const date = new Date(timestamp);
    return date.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  } catch {
    return timestamp;
  }
}

export function ExploitLiveStream({
  exploitSessionId,
}: ExploitLiveStreamProps) {
  const [events, setEvents] = useState<SSEEvent[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  const [hasError, setHasError] = useState(false);
  const eventSourceRef = useRef<EventSource | null>(null);
  const lastEventRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const exploitAgentUrl = process.env.NEXT_PUBLIC_EXPLOIT_AGENT_URL;

    // Check if EventSource is available (not available in test environment)
    if (typeof EventSource === "undefined") {
      return;
    }

    if (!exploitAgentUrl) {
      setHasError(true);
      return;
    }

    const streamUrl = `${exploitAgentUrl}/api/sessions/${exploitSessionId}/stream`;
    const eventSource = new EventSource(streamUrl);
    eventSourceRef.current = eventSource;

    eventSource.onopen = () => {
      setIsConnected(true);
      setHasError(false);
    };

    eventSource.onerror = () => {
      setIsConnected(false);
      setHasError(true);
    };

    // Listen for all event types
    const eventTypes = ["thought", "command", "output", "result", "done"];
    eventTypes.forEach((type) => {
      eventSource.addEventListener(type, (event) => {
        try {
          const data = JSON.parse(event.data);
          const newEvent: SSEEvent = {
            type: type as SSEEvent["type"],
            data,
            timestamp: new Date().toISOString(),
          };
          setEvents((prev) => [...prev, newEvent]);

          // Close connection when done
          if (type === "done") {
            eventSource.close();
            setIsConnected(false);
          }
        } catch (error) {
          console.error("Failed to parse SSE event:", error);
        }
      });
    });

    return () => {
      eventSource.close();
    };
  }, [exploitSessionId]);

  // Auto-scroll to bottom when new events arrive
  useEffect(() => {
    if (typeof lastEventRef.current?.scrollIntoView === "function") {
      lastEventRef.current.scrollIntoView({ behavior: "smooth", block: "end" });
    }
  }, [events.length]);

  if (typeof EventSource === "undefined") {
    return null;
  }

  return (
    <div className="rounded-xl border border-border bg-card">
      <div className="border-b border-border px-4 py-3">
        <div className="flex items-center gap-2">
          <h3 className="text-sm font-semibold">모의 침투 실시간 로그</h3>
          {isConnected && (
            <span className="h-2 w-2 animate-pulse rounded-full bg-green-500" />
          )}
          {hasError && (
            <span className="text-xs text-yellow-600">
              연결 실패 (폴링으로 대체됨)
            </span>
          )}
        </div>
      </div>
      <div className="max-h-[500px] space-y-2 overflow-y-auto p-4">
        {events.length === 0 && !hasError && (
          <p className="text-sm text-muted-foreground">
            실시간 로그를 기다리는 중...
          </p>
        )}
        {events.map((event, idx) => {
          const isLast = idx === events.length - 1;
          return (
            <div
              key={idx}
              className="rounded-lg border border-border bg-muted/30 p-3"
              ref={isLast ? lastEventRef : null}
            >
              {/* Event header */}
              <div className="mb-1 flex items-center justify-between text-xs text-muted-foreground">
                <span className="font-mono">{formatTime(event.timestamp)}</span>
                <span className="font-medium uppercase">{event.type}</span>
              </div>

              {/* Event content based on type */}
              {event.type === "thought" && (
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    {event.data.vulnerability_type != null && (
                      <span className="rounded-full bg-purple-500/10 px-2 py-0.5 text-xs font-medium text-purple-600">
                        {String(event.data.vulnerability_type)}
                      </span>
                    )}
                    {event.data.iteration != null && (
                      <span className="text-xs text-muted-foreground">
                        반복 {String(event.data.iteration)}
                      </span>
                    )}
                  </div>
                  <p className="ml-4 text-sm italic text-muted-foreground">
                    {String(event.data.thought || "")}
                  </p>
                </div>
              )}

              {event.type === "command" && (
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <span className="rounded-full bg-blue-500/10 px-2 py-0.5 text-xs font-medium text-blue-600">
                      {String(event.data.tool || "")}
                    </span>
                    {event.data.iteration != null && (
                      <span className="text-xs text-muted-foreground">
                        반복 {String(event.data.iteration)}
                      </span>
                    )}
                  </div>
                  <div className="rounded bg-muted p-2 font-mono text-xs">
                    {JSON.stringify(event.data.arguments || {}, null, 2)}
                  </div>
                </div>
              )}

              {event.type === "output" && (
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    <span className="rounded-full bg-gray-500/10 px-2 py-0.5 text-xs font-medium text-gray-600">
                      {String(event.data.tool || "")}
                    </span>
                    {event.data.iteration != null && (
                      <span className="text-xs text-muted-foreground">
                        반복 {String(event.data.iteration)}
                      </span>
                    )}
                  </div>
                  <details className="cursor-pointer">
                    <summary className="text-xs text-muted-foreground hover:text-foreground">
                      출력 보기
                    </summary>
                    <pre className="mt-1 max-h-32 overflow-y-auto whitespace-pre-wrap rounded bg-muted p-2 font-mono text-xs">
                      {String(event.data.output || "").slice(0, 500)}
                      {String(event.data.output || "").length > 500 && "..."}
                    </pre>
                  </details>
                </div>
              )}

              {event.type === "result" && (
                <div className="space-y-1">
                  <div className="flex items-center gap-2">
                    {event.data.success ? (
                      <span className="rounded-full bg-green-500/10 px-2 py-0.5 text-xs font-medium text-green-600">
                        침투 성공
                      </span>
                    ) : (
                      <span className="rounded-full bg-gray-500/10 px-2 py-0.5 text-xs font-medium text-gray-600">
                        침투 실패
                      </span>
                    )}
                    {event.data.vulnerability_type != null && (
                      <span className="text-xs text-muted-foreground">
                        {String(event.data.vulnerability_type)}
                      </span>
                    )}
                  </div>
                  {event.data.location != null && (
                    <p className="text-xs text-muted-foreground">
                      위치: {String(event.data.location)}
                    </p>
                  )}
                  {event.data.evidence != null && (
                    <details className="cursor-pointer">
                      <summary className="text-xs text-muted-foreground hover:text-foreground">
                        증거 보기
                      </summary>
                      <pre className="mt-1 whitespace-pre-wrap rounded bg-muted p-2 font-mono text-xs">
                        {String(event.data.evidence)}
                      </pre>
                    </details>
                  )}
                </div>
              )}

              {event.type === "done" && (
                <div className="rounded-lg bg-indigo-500/5 p-3">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-semibold text-indigo-600">
                      침투 테스트 완료
                    </span>
                    <span className="rounded-full bg-indigo-500/10 px-2 py-0.5 text-xs font-medium text-indigo-600">
                      {String(event.data.status || "")}
                    </span>
                  </div>
                  <div className="mt-2 flex gap-4 text-xs">
                    <span className="text-muted-foreground">
                      성공: {String(event.data.exploited_count || 0)}
                    </span>
                    <span className="text-muted-foreground">
                      실패: {String(event.data.failed_count || 0)}
                    </span>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}
