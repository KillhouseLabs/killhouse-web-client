export interface Finding {
  type?: string;
  severity: string;
  title?: string;
  file_path?: string;
  line?: number;
  url?: string;
  cwe?: string;
}

export interface Report {
  tool: string;
  findings: Finding[];
}

export function buildDedupKey(finding: Finding): string {
  const isSast = finding.type === "sast";
  const identifier = finding.cwe || finding.title || "unknown";

  if (isSast) {
    return `sast:${identifier}:${finding.file_path || ""}:${finding.line ?? ""}`;
  }
  return `dast:${identifier}:${finding.url || ""}`;
}

export function parseReportFindings(reportJson: string | null): Finding[] {
  if (!reportJson) return [];
  try {
    const reports: Report[] = JSON.parse(reportJson);
    if (!Array.isArray(reports)) return [];
    return reports.flatMap((r) => r.findings || []);
  } catch {
    return [];
  }
}

export function isCriticalSeverity(severity: string): boolean {
  return severity.toLowerCase() === "critical";
}
